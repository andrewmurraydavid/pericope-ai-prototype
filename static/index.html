<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App</title>
</head>

<body>
  <input type="text" id="inputField" oninput="debounce(fetchPrediction, 800)()" style="
    width: 600px;
    height: 30px;
    border: 1px solid #467f3b;
    border-radius: 8px;
    padding: 8px;
    margin: 8px;
    font-size: 16px;
    outline: 1px solid #467f3b;
    "
    placeholder="Enter a story name..."
    >
  <div id="dropdown"></div>

  <script>
    function debounce(func, wait = 200, immediate = true) {
      var timeout;
      return function() {
        var context = this,
          args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };

    function fetchPrediction() {
      const inputField = document.getElementById('inputField');
      const dropdown = document.getElementById('dropdown');

      if (inputField.value) {
        if (inputField.value.split(' ').length < 2) {
          dropdown.innerHTML = 'You need to enter at least 2 words.';
          return;
        }

        fetch('/predict', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ "input": inputField.value })
        })
          .then(response => response.json())
          .then(data => {
            // the data is an array of objects, iterate over it
            dropdown.innerHTML = '';
            data.forEach(item => {
              // create a new div element
              const div = document.createElement('div');
              div.style = `
                display: flex;
                justify-content: space-between;
                width: 600px;
                padding: 8px;
                border: 1px solid #467f3b;
                border-radius: 8px;
                margin: 8px;

                /* put border on the bottom of the last element */
                ${data.indexOf(item) !== data.length - 1 ? `
                  border-bottom: none;
                  margin-bottom: 0;
                  border-bottom-left-radius: 0;
                  border-bottom-right-radius: 0;
                  ` : ''}

                /* put border on the top of the first element */
                ${data.indexOf(item) !== 0 ? `
                  border-top: none;
                  margin-top: 0;
                  border-top-left-radius: 0;
                  border-top-right-radius: 0;

                  ` : ''}

              `;
              const distance = item.distance.toFixed(3);

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = item.id;
              checkbox.value = item.id;
              checkbox.style = 'margin-right: 10px;';

              const refDiv = document.createElement('div')
              refDiv.style = 'display:flex; justify-content: flex-start; width: 180px; font-size: 14px; padding-right: 10px;';
              const pericopeDiv = document.createElement('div')
              pericopeDiv.style = 'display:flex; justify-content: flex-start; width: 400px; font-weight: bold; padding-right: 10px;';
              const distanceDiv = document.createElement('div')
              distanceDiv.style = 'display:flex; justify-content: flex-end; width: 100px; font-size: 12px; color: grey;';

              refDiv.innerHTML = item.metadata.reference;
              pericopeDiv.innerHTML = item.pericope;
              distanceDiv.innerHTML = `Dist: ${distance}`;

              div.append(checkbox, refDiv, pericopeDiv, distanceDiv)
              // append the div to the dropdown
              dropdown.appendChild(div);
            });

            
          });
      } else {
        dropdown.innerHTML = '';
      }
    }
  </script>
</body>

</html>